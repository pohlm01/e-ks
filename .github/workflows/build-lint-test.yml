name: Build, lint & test

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

env:
  TZ: "Europe/Amsterdam"
  SQLX_OFFLINE: "true"

jobs:
  changes:
    runs-on: ubuntu-24.04
    outputs:
      changed: ${{ steps.filter.outputs.changed }}
    steps:
      - uses: actions/checkout@v6.0.1
        with:
          fetch-depth: '0'
      - name: Filter changes for non-Markdown files
        id: filter
        run: | 
          if [[ $(git diff --name-only "origin/${{ github.base_ref }}" HEAD | grep -v "\.md$") ]]  ; then 
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  format:
    name: Rust format
    if: ${{ needs.changes.outputs.changed == 'true' }}
    needs: changes
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Setup Rust
        shell: bash
        run: >
          rustup update nightly &&
          rustup default nightly &&
          rustup component add --toolchain nightly rustfmt

      - name: Check rustfmt
        run: cargo --locked fmt --all -- --check

  rust:
    name: clippy, test & build
    if: ${{ needs.changes.outputs.changed == 'true' }}
    needs: changes
    runs-on: ubuntu-24.04
    env:
      CARGO_TERM_COLOR: always
      SQLX_OFFLINE: "true"
      RUSTDOCFLAGS: "-D warnings"
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Install musl
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Setup Rust
        shell: bash
        run: >
          rustup update stable &&
          rustup default stable &&
          rustup target add x86_64-unknown-linux-musl &&
          rustup component add --toolchain stable clippy rust-docs

      - name: Cargo cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: eks

      - name: Tools cache
        uses: actions/cache@v5
        with:
          path: bin
          key: tools-cache-v1-${{ runner.os }}-${{ hashFiles('development/Cargo.toml', 'development/src/*.rs', 'development/*.yml') }}

      - name: Setup project
        run: bin/init

      - name: Lint Typescript using Biome
        run: ./bin/biome check --error-on-warnings ./frontend/scripts

      - name: Lint CSS using Biome
        run: ./bin/biome check --error-on-warnings ./frontend/styles

      - name: Check Clippy with all features
        run: cargo --locked clippy --target=x86_64-unknown-linux-musl --all-targets --all-features -- -D warnings

      - name: Check Clippy without default features
        run: cargo --locked clippy --target=x86_64-unknown-linux-musl --all-targets --no-default-features -- -D warnings

      - name: Run tests
        run: cargo --locked test --target=x86_64-unknown-linux-musl -- --nocapture

      - name: Build docs
        run: cargo doc --workspace --no-deps --all-features

      - name: Build
        run: cargo --locked build --target=x86_64-unknown-linux-musl

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: e-ks-core
          path: target/x86_64-unknown-linux-musl/debug/e-ks-core

  playwright:
    name: Playwright tests
    if: ${{ needs.changes.outputs.changed == 'true' }}
    needs: changes
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    env:
      CARGO_TERM_COLOR: always
      PLAYWRIGHT_BROWSERS_PATH: .cache/playwright
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        shell: bash
        run: >
          rustup update stable

      - name: Cargo cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: eks

      - name: Tools cache
        uses: actions/cache@v5
        with:
          path: bin
          key: tools-cache-v1-${{ runner.os }}-${{ hashFiles('development/Cargo.toml', 'development/src/*.rs', 'development/*.yml') }}

      - name: Setup project
        run: bin/init

      - name: Run playwright tests
        run: bin/test

  audit-dependencies:
    name: Audit dependencies
    if: ${{ needs.changes.outputs.changed == 'true' }}
    needs: changes
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: EmbarkStudios/cargo-deny-action@76cd80eb775d7bbbd2d80292136d74d39e1b4918
        with:
          arguments: --workspace --all-features
