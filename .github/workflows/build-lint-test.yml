name: Build, lint & test

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

env:
  TZ: "Europe/Amsterdam"


jobs:
  newline:
    name: Check every file has a newline at the end
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1
      - name: Check newline
        shell: bash
        run: ./.github/workflows/check_newline.sh

  format:
    name: Rust format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1
      - name: Setup Rust
        shell: bash
        run: >
          rustup update nightly &&
          rustup default nightly &&
          rustup component add --toolchain nightly rustfmt

      - name: Check rustfmt
        run: cargo --locked fmt --all -- --check

  rust:
    name: clippy, test & build
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      SQLX_OFFLINE: "true"
      RUSTDOCFLAGS: "-D warnings"
    steps:
      - uses: actions/checkout@v6.0.1
      # Compile and test
      - name: Install musl
        run: sudo apt-get update && sudo apt-get install -y musl-tools
      - name: Setup Rust
        shell: bash
        run: >
          rustup update stable &&
          rustup default stable &&
          rustup target add x86_64-unknown-linux-musl &&
          rustup component add --toolchain stable clippy rust-docs
      - name: Cargo cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          workspaces: ". -> target"
      - name: Check Clippy with all features
        run: cargo --locked clippy --target=x86_64-unknown-linux-musl --all-targets --all-features -- -D warnings
      - name: Check Clippy without default features
        run: cargo --locked clippy --target=x86_64-unknown-linux-musl --all-targets --no-default-features -- -D warnings
      - name: Run tests
        run: cargo --locked test --target=x86_64-unknown-linux-musl -- --nocapture
      - name: Build docs
        run: cargo doc --workspace --no-deps --all-features
      - name: Build
        run: cargo --locked build --target=x86_64-unknown-linux-musl
      - uses: actions/upload-artifact@v5
        with:
          name: e-ks-core
          path: target/x86_64-unknown-linux-musl/debug/e-ks-core

  pdf-gen:
    name: PDF generator clippy, test & build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./pdf-gen
    env:
      CARGO_TERM_COLOR: always
      RUSTDOCFLAGS: "-D warnings"
    steps:
      - uses: actions/checkout@v6.0.1
      # Compile and test
      - name: Install musl
        run: sudo apt-get update && sudo apt-get install -y musl-tools
      - name: Setup Rust
        shell: bash
        run: >
          rustup update stable &&
          rustup default stable &&
          rustup target add x86_64-unknown-linux-musl &&
          rustup component add --toolchain stable clippy
      - name: Cargo cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          workspaces: "pdf-gen -> target"
      - name: Check Clippy with all features
        run: cargo --locked clippy --target=x86_64-unknown-linux-musl --all-targets --all-features -- -D warnings
      - name: Check Clippy without default features
        run: cargo --locked clippy --target=x86_64-unknown-linux-musl --all-targets --no-default-features -- -D warnings
      - name: Run tests
        run: cargo --locked test --target=x86_64-unknown-linux-musl -- --nocapture
      - name: Build
        run: cargo --locked build --target=x86_64-unknown-linux-musl
      - uses: actions/upload-artifact@v5
        with:
          name: pdf-gen
          path: target/x86_64-unknown-linux-musl/debug/pdf-gen

  audit-dependencies:
    name: Audit dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: EmbarkStudios/cargo-deny-action@76cd80eb775d7bbbd2d80292136d74d39e1b4918
        with:
          arguments: --workspace --all-features
