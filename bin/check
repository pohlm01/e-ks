#!/bin/bash

set -euo pipefail

export MEMORY_SERVE_QUIET=1

# check postgres is running
if docker compose exec -T psql pg_isready -U eks; then
    cargo sqlx migrate run --database-url postgres://eks@localhost/eks
    cargo sqlx prepare --database-url postgres://eks@localhost/eks -- --all-features
fi

# rust
cargo check --all-features
cargo +nightly fmt --all -- --config imports_granularity="Crate"
cargo clippy --all-targets --all-features -- -D warnings
cargo test --all-features

# typescript
./bin/biome format --fix ./frontend
./bin/biome check --error-on-warnings ./frontend 

# generic
./bin/check_newline
